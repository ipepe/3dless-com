(function(){window.ThreejsSimplifier=function(){function e(e,t){this.renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0,useDevicePixelRatio:!1,devicePixelRatio:1,alpha:!0,antialias:!0}),this.preview=$(e),this.preview.append(this.renderer.domElement),this.camera=new THREE.PerspectiveCamera(45,this.width()/this.height(),.1,1e4),this.scene=new THREE.Scene,this.scene.add(this.camera),this.autosize(),this.renderer.setClearColor(0,0),this.simplifyModifier=new THREE.SimplifyModifier,this.material=new THREE.MeshPhongMaterial({color:"#fff"}),this.meshmaterials=[new THREE.MeshPhongMaterial({color:"#fff",shading:THREE.FlatShading}),new THREE.MeshBasicMaterial({color:4214848,wireframe:!0,opacity:.8,transparent:!0})],this.onGeometryChange=t,this.loadDefaultModel(),this.setupCameraAndControls(),this.setupLight(),this.animate()}return e.prototype.renderer=null,e.prototype.camera=null,e.prototype.scene=null,e.prototype.preview=null,e.prototype.mesh=null,e.prototype.original_geometry=null,e.prototype.onGeometryChange=null,e.prototype.controls=null,e.prototype.processing=!1,e.prototype.simplifyMeshTo=function(e){return this.mesh.children[0].geometry.vertices.length===e?console.log("same vertices as requested"):e===this.original_geometry.vertices.length?this.createMesh(this.original_geometry,!1):this.processing?setTimeout(function(t){return function(){return t.simplifyMeshTo(e)}}(this),50):(console.log("simplifying",this.original_geometry.vertices.length,"to",e),this.isFastProcessing()||$("#loader").addClass("loader"),this.processing=!0,!0,setTimeout(function(t){return function(){var r,i;return r=t.original_geometry.clone(),i=t.simplifyModifier.modify(r,e),i.computeFaceNormals(),t.createMesh(i,!1),t.processing=!1}}(this),50))},e.prototype.createMesh=function(e,t){return null==t&&(t=!0),this.mesh&&(this.scene.remove(this.mesh),this.mesh=null),e.isBufferGeometry&&(e=(new THREE.Geometry).fromBufferGeometry(e)),e.center(),e.mergeVertices(),e.computeFaceNormals(),e.computeFlatVertexNormals(),t&&(this.original_geometry=e.clone(),"function"==typeof this.onGeometryChange&&this.onGeometryChange(e.vertices.length)),this.mesh=new THREE.SceneUtils.createMultiMaterialObject(e,this.meshmaterials),this.mesh.castShadow=!0,this.mesh.receiveShadow=!0,this.scene.add(this.mesh),$("#loader").removeClass("loader")},e.prototype.isFastProcessing=function(){var e,t;return!!((null!=(e=this.original_geometry)&&null!=(t=e.vertices)?t.length:void 0)<8e3)},e.prototype.logSlider=function(e,t,r){var i,n,o;return null==t&&(t=1e3),null==r&&(r=1),e=parseInt(e),t=parseInt(t),r=parseInt(r),n=Math.log(8),i=Math.log(this.original_geometry.vertices.length),e===r?8:e===t?this.original_geometry.vertices.length:(o=(i-n)/(t-r),parseInt(Math.exp(n+o*(e-r))))},e.prototype.loadDefaultModel=function(){var e;return $("#loader").addClass("loader"),e=new THREE.RabbitGeometry,e.rotateX(Math.PI/2),this.smothenGeometry(e,2),e.scale(100,100,100),this.createMesh(e)},e.prototype.smothenGeometry=function(e,t){var r;return null==t&&(t=2),r=new THREE.SubdivisionModifier(t),r.modify(e)},e.prototype.parseSTL=function(e){return $("#loader").addClass("loader"),setTimeout(function(t){return function(){return t.createMesh((new THREE.STLLoader).parse(e))}}(this),50)},e.prototype.exportMesh=function(){return new Blob([(new THREE.STLBinaryExporter).parse(this.mesh.children[0])],{type:"application/octet-stream"})},e.prototype.setupCameraAndControls=function(){return this.camera.updateProjectionMatrix(),this.camera.lookAt(new THREE.Vector3(0,25,0)),this.camera.up.set(0,0,1),this.controls=new THREE.OrbitControls(this.camera,this.renderer.domElement),this.controls.autoRotate=!0,this.camera.position.set(-135,75,75),this.controls.update()},e.prototype.setupLight=function(){var e,t,r;return r=new THREE.HemisphereLight(16777215,16777215,.6),r.color.setHSL(.6,1,.6),r.groundColor.setHSL(.095,1,.75),r.position.set(0,50,0),this.scene.add(r),t=new THREE.DirectionalLight(16777215,1),t.color.setHSL(.1,1,.95),t.position.set(1,-1.75,1),t.position.multiplyScalar(30),this.scene.add(t),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,e=50,t.shadow.camera.left=-e,t.shadow.camera.right=e,t.shadow.camera.top=e,t.shadow.camera.bottom=-e,t.shadow.camera.far=3500,t.shadow.bias=-1e-4},e.prototype.autosize=function(){return this.renderer.setSize(this.width(),this.height()),this.camera.aspect=this.width()/this.height(),this.camera.updateProjectionMatrix()},e.prototype.width=function(){var e,t;return t=parseInt(this.preview.css("border-right-width")),e=parseInt(this.preview.css("border-left-width")),this.preview.parent().width()-e-t},e.prototype.height=function(){var e,t;return t=parseInt(this.preview.css("border-top-width")),e=parseInt(this.preview.css("border-bottom-width")),this.preview.parent().height()-t-e},e.prototype.animate=function(){return this.render(),window.requestAnimationFrame(function(e){return function(){return e.animate()}}(this))},e.prototype.render=function(){return this.controls.update(),this.renderer.render(this.scene,this.camera)},e}(),$().ready(function(){var e,t,r,i;return window.ThreejsApp=new ThreejsSimplifier("#threejs",function(e){return $("#vertices_number_input").attr("value",e)}),$(window).resize(function(){return ThreejsApp.autosize()}),i=function(e,t){if(ThreejsApp.isFastProcessing()||"change"===e.type)return setTimeout(function(){return ThreejsApp.simplifyMeshTo(t)},50)},t=debounce(i),$("#vertices_range_input").on("mousemove touchmove touchend mouseup change",function(e){var r;return r=ThreejsApp.logSlider(e.target.value,e.target.max,e.target.min),$("#vertices_number_input").attr("value",r),t(e,r)}),e=debounce(function(){return ThreejsApp.controls.autoRotate=!0},1e4),$("#threejs canvas").on("mouseup touchend",function(){return ThreejsApp.controls.autoRotate=!1,e()}),r=document.getElementById("file_input"),$(r).on("change",function(e){var t;if($(".jumbotron").addClass("hidden"),document.getElementById("vertices_range_input").value=1e3,e.target.files.length)return setTimeout(function(){return ga("send","event","simplifier","filechosen")},100),t=new FileReader,t.onloadend=function(){return function(e){return ThreejsApp.parseSTL(e.target.result)}}(),t.readAsArrayBuffer(e.target.files[0])}),$("#save").on("click",function(){var e,t,i,n,o;return e=ThreejsApp.exportMesh(),t=(null!=r&&null!=(i=r.files)?i.length:void 0)&&(null!=(n=r.files[0])&&null!=(o=n.name)?o.length:void 0)?r.files[0].name.slice(0,-4):"",t+="_3dless_com_simplified.stl",window.saveAs(e,t),setTimeout(function(){return ga("send","event","simplifier","filesaved")},100)})})}).call(this);